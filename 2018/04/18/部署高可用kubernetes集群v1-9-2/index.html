<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>部署高可用kubernetes集群v1.9.2 | H22F's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">部署高可用kubernetes集群v1.9.2</h1><a id="logo" href="/.">H22F's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">部署高可用kubernetes集群v1.9.2</h1><div class="post-meta">Apr 18, 2018</div><div class="post-content"><h1 id="1-kubernetes-高可用架构"><a href="#1-kubernetes-高可用架构" class="headerlink" title="1.kubernetes 高可用架构"></a>1.kubernetes 高可用架构</h1><p><img src="https://www.kubernetes.org.cn/img/2018/01/ha11.png" alt="image"></p>
<h1 id="2-环境规划"><a href="#2-环境规划" class="headerlink" title="2.环境规划"></a>2.环境规划</h1><table>
<thead>
<tr>
<th>软件</th>
<th style="text-align:left">版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>操作系统</td>
<td style="text-align:left">Centos 7.x_64</td>
</tr>
<tr>
<td>Kubernetes</td>
<td style="text-align:left">1.9.2</td>
</tr>
<tr>
<td>Docker</td>
<td style="text-align:left">17.12-ce</td>
</tr>
<tr>
<td>Etcd</td>
<td style="text-align:left">3.0</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>组件</th>
<th>推荐配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>LB01</td>
<td>10.20.143.12</td>
<td>haproxy</td>
<td>CPU 4核 + 内存 4G + 硬盘 100G</td>
</tr>
<tr>
<td>Master01</td>
<td>10.20.143.13</td>
<td>kube-apiserver<br>kube-controller-manager<br>kube-scheduler<br>etcd<br>docker<br>calico</td>
<td>:::</td>
</tr>
<tr>
<td>Master02</td>
<td>10.20.143.14</td>
<td>:::</td>
<td>:::</td>
</tr>
<tr>
<td>Master03</td>
<td>10.20.143.15</td>
<td>:::</td>
<td>:::</td>
</tr>
<tr>
<td>Node01</td>
<td>10.20.143.16</td>
<td>kubelet<br>kube-proxy<br>docker<br>calico<br>etcd</td>
<td>:::</td>
</tr>
<tr>
<td>Node02</td>
<td>10.20.143.17</td>
<td>:::</td>
<td>:::</td>
</tr>
</tbody>
</table>
<h1 id="3-准备工作"><a href="#3-准备工作" class="headerlink" title="3.准备工作"></a>3.准备工作</h1><h2 id="3-1-修改主机名，kubernetes集群会识别主机名，确保主机名唯一（每台节点上）"><a href="#3-1-修改主机名，kubernetes集群会识别主机名，确保主机名唯一（每台节点上）" class="headerlink" title="3.1. 修改主机名，kubernetes集群会识别主机名，确保主机名唯一（每台节点上）"></a>3.1. 修改主机名，kubernetes集群会识别主机名，确保主机名唯一（每台节点上）</h2><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $&#123;hostname&#125;变量请替换成规划的主机名，比如ns.k8s.master01,ns.k8s.node01</span></span><br><span class="line">$ <span class="string">hostnamectl </span><span class="built_in">set-hostname</span> $&#123;<span class="string">hostname&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="3-2-安装Docker（每台节点上）"><a href="#3-2-安装Docker（每台节点上）" class="headerlink" title="3.2. 安装Docker（每台节点上）"></a>3.2. 安装Docker（每台节点上）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">0.删除旧版dokcer,如果默认之前yum安装的1.12版本,可以这样删没装可以跳过此步</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum remove -y docker*</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">1.安装需要的包</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install -y yum-utils \</span></span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2   libtool-ltdl  libseccomp</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2.添加阿里云源,</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3.根据实际查找当前版本 (可选)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum list docker-ce --showduplicates | sort -r</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">4.安装17.12.0版本</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum -y install  docker-ce-17.12.0.ce</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">5.配置Dokcer启动参数</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /etc/docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">"log-opts": &#123;</span><br><span class="line">	"max-size": "100m",</span><br><span class="line">	"max-file": "10"</span><br><span class="line">	 &#125;,</span><br><span class="line">"graph": "/opt/data/docker/"</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">6.开启docker服务,和开机启动</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start docker &amp;&amp; systemctl <span class="built_in">enable</span> docker</span></span><br></pre></td></tr></table></figure>
<h2 id="3-3-上传安装包-kubernetes1-9-2-tar-gz-到每个节点-opt-下"><a href="#3-3-上传安装包-kubernetes1-9-2-tar-gz-到每个节点-opt-下" class="headerlink" title="3.3. 上传安装包 ( kubernetes1.9.2.tar.gz )到每个节点  /opt 下"></a>3.3. 上传安装包 ( <font color="red">kubernetes1.9.2.tar.gz</font> )到每个节点 <font color="red"> /opt</font> 下</h2><h3 id="3-3-1-解压安装包"><a href="#3-3-1-解压安装包" class="headerlink" title="3.3.1. 解压安装包"></a>3.3.1. 解压安装包</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf /<span class="keyword">opt</span>/kubernetes1.<span class="number">9.2</span>.tar.gz -C /<span class="keyword">opt</span>/ &amp;&amp; <span class="keyword">cd</span> /<span class="keyword">opt</span>/kubernetes1.<span class="number">9.2</span> &amp;&amp; <span class="keyword">find</span> ./ -name <span class="string">'._*'</span> -<span class="keyword">delete</span></span><br></pre></td></tr></table></figure>
<h3 id="3-3-2-安装包介绍"><a href="#3-3-2-安装包介绍" class="headerlink" title="3.3.2. 安装包介绍"></a>3.3.2. 安装包介绍</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">├── <span class="selector-tag">bin</span>   # 所需要的<span class="selector-tag">kubernetes</span>相关的<span class="selector-tag">bin</span>文件</span><br><span class="line">│   ├── <span class="selector-tag">cfssl</span> # 自签证书工具</span><br><span class="line">│   │   ├── <span class="selector-tag">cfssl</span></span><br><span class="line">│   │   ├── <span class="selector-tag">cfssl-certinfo</span></span><br><span class="line">│   │   └── <span class="selector-tag">cfssljson</span></span><br><span class="line">│   ├── <span class="selector-tag">etcd-v3</span><span class="selector-class">.2</span><span class="selector-class">.12-linux-amd64</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">│   ├── <span class="selector-tag">kubeadm</span> # 快速创建<span class="selector-tag">kubernetes</span>集群的工具</span><br><span class="line">│   ├── <span class="selector-tag">kubectl</span> # <span class="selector-tag">kubernetes</span>的基础组件，负责对<span class="selector-tag">pod</span>和<span class="selector-tag">container</span>的创建和管理，与<span class="selector-tag">kubernetes</span>集群<span class="selector-tag">master</span>建立联系</span><br><span class="line">│   └── <span class="selector-tag">kubelet</span> # <span class="selector-tag">kubernetes</span>的客户端工具，用来像集群发送命名</span><br><span class="line">├── <span class="selector-tag">configuration</span> # 所有的配置文件</span><br><span class="line">│   ├── <span class="selector-tag">dashboard</span> # <span class="selector-tag">dashboard</span>相关配置</span><br><span class="line">│   │   ├── <span class="selector-tag">dashboard-admin</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   └── <span class="selector-tag">kubernetes-dashboard</span><span class="selector-class">.yaml</span></span><br><span class="line">│   ├── <span class="selector-tag">haproxy</span> # <span class="selector-tag">haproxy</span>相关配置</span><br><span class="line">│   │   └── <span class="selector-tag">haproxy</span><span class="selector-class">.cfg</span></span><br><span class="line">│   ├── <span class="selector-tag">heapster</span> #  <span class="selector-tag">heapster</span>相关<span class="selector-tag">yaml</span>配置</span><br><span class="line">│   │   ├── <span class="selector-tag">influxdb</span></span><br><span class="line">│   │   │   ├── <span class="selector-tag">grafana</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   │   ├── <span class="selector-tag">heapster</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   │   └── <span class="selector-tag">influxdb</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   └── <span class="selector-tag">rbac</span></span><br><span class="line">│   │       └── <span class="selector-tag">heapster-rbac</span><span class="selector-class">.yaml</span></span><br><span class="line">│   ├── <span class="selector-tag">ingress</span> # 路由配置</span><br><span class="line">│   │   ├── <span class="selector-tag">README</span><span class="selector-class">.md</span></span><br><span class="line">│   │   ├── <span class="selector-tag">configmap</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">default-backend</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">namespace</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">provider</span></span><br><span class="line">│   │   │   └── <span class="selector-tag">baremetal</span></span><br><span class="line">│   │   │       └── <span class="selector-tag">service-nodeport</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">rbac</span><span class="selector-class">.md</span></span><br><span class="line">│   │   ├── <span class="selector-tag">rbac</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">tcp-services-configmap</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">udp-services-configmap</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   └── <span class="selector-tag">with-rbac</span><span class="selector-class">.yaml</span></span><br><span class="line">│   ├── <span class="selector-tag">kube</span> # <span class="selector-tag">kubernetes</span>自身配置</span><br><span class="line">│   │   ├── 10<span class="selector-tag">-kubeadm</span><span class="selector-class">.conf</span></span><br><span class="line">│   │   ├── <span class="selector-tag">config</span> # <span class="selector-tag">kubeadm</span>配置</span><br><span class="line">│   │   └── <span class="selector-tag">kubelet</span><span class="selector-class">.service</span></span><br><span class="line">│   ├── <span class="selector-tag">net</span> # 网络相关配置</span><br><span class="line">│   │   ├── <span class="selector-tag">calico-tls</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   ├── <span class="selector-tag">calicoctl</span><span class="selector-class">.yaml</span></span><br><span class="line">│   │   └── <span class="selector-tag">rbac</span><span class="selector-class">.yaml</span></span><br><span class="line">│   └── <span class="selector-tag">ssl</span> # 自签证书配置</span><br><span class="line">│       ├── <span class="selector-tag">ca-config</span><span class="selector-class">.json</span></span><br><span class="line">│       ├── <span class="selector-tag">ca-csr</span><span class="selector-class">.json</span></span><br><span class="line">│       └── <span class="selector-tag">client</span><span class="selector-class">.json</span></span><br><span class="line">├── <span class="selector-tag">image</span> # 依赖的所有镜像包</span><br><span class="line">│   └── <span class="selector-tag">images</span><span class="selector-class">.tar</span></span><br><span class="line">└── <span class="selector-tag">shell</span> # 初始化脚本</span><br><span class="line">    └── <span class="selector-tag">init</span><span class="selector-class">.sh</span> # 初始化节点,安装<span class="selector-tag">bin</span>文件，<span class="selector-tag">systemd</span>配置 , 关闭防火墙 , <span class="selector-tag">SELINUX</span>等</span><br></pre></td></tr></table></figure>
<h3 id="3-3-3-节点初始化-所有节点"><a href="#3-3-3-节点初始化-所有节点" class="headerlink" title="3.3.3. 节点初始化 (所有节点) "></a>3.3.3. 节点初始化<font color="red"> (所有节点) </font></h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">cd</span> /<span class="keyword">opt</span>/kubernetes1.<span class="number">9.2</span>/<span class="keyword">shell</span> &amp;&amp; <span class="keyword">sh</span> init.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<h1 id="4-集群部署"><a href="#4-集群部署" class="headerlink" title="4.集群部署"></a>4.集群部署</h1><h2 id="4-1-自签TLS证书"><a href="#4-1-自签TLS证书" class="headerlink" title="4.1. 自签TLS证书"></a>4.1. 自签TLS证书</h2><table>
<thead>
<tr>
<th>组件</th>
<th>使用的证书</th>
</tr>
</thead>
<tbody>
<tr>
<td>etcd</td>
<td>ca.pem , server.pem , server-key.pem , peer.pem , peer-key.pem</td>
</tr>
<tr>
<td>calico</td>
<td>ca.pem , client.pem , client-key.pem</td>
</tr>
<tr>
<td>kube-apiserver</td>
<td>ca.pem , client.pem , client-key.pem</td>
</tr>
<tr>
<td>kubelet</td>
<td>ca.pem , ca-key.pem</td>
</tr>
<tr>
<td>kube-proxy</td>
<td>ca.pem , client.pem , client-key.pem</td>
</tr>
<tr>
<td>kubectl</td>
<td>ca.pem , client.pem , client-key.pem</td>
</tr>
</tbody>
</table>
<h3 id="4-1-1-安装cfssl-cfssljson-cfssl-certinfo-在三台Master上执行"><a href="#4-1-1-安装cfssl-cfssljson-cfssl-certinfo-在三台Master上执行" class="headerlink" title="4.1.1. 安装cfssl , cfssljson , cfssl-certinfo (在三台Master上执行)"></a>4.1.1. 安装cfssl , cfssljson , cfssl-certinfo <font color="red">(在三台Master上执行)</font></h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mv <span class="meta-keyword">/opt/</span>kubernetes1<span class="number">.9</span><span class="number">.2</span><span class="meta-keyword">/bin/</span>cfssl/cfssl* <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/bin/</span></span><br><span class="line">$ chmod +x <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/bin/</span>cfssl*</span><br></pre></td></tr></table></figure>
<h3 id="4-1-2-生成ca证书-只要在Master01上执行-ca-key-pem-ca-pem-ca-csr"><a href="#4-1-2-生成ca证书-只要在Master01上执行-ca-key-pem-ca-pem-ca-csr" class="headerlink" title="4.1.2. 生成ca证书 只要在Master01上执行 (ca-key.pem,ca.pem,ca.csr)"></a>4.1.2. 生成ca证书 <font color="red">只要在Master01上执行 (ca-key.pem,ca.pem,ca.csr)</font></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/kubernetes1.9.2/configuration/ssl</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-3-生成client证书-只要在Master01上执行-client-key-pem-client-pem-client-csr"><a href="#4-1-3-生成client证书-只要在Master01上执行-client-key-pem-client-pem-client-csr" class="headerlink" title="4.1.3. 生成client证书 只要在Master01上执行 (client-key.pem,client.pem,client.csr)"></a>4.1.3. 生成client证书 <font color="red">只要在Master01上执行 (client-key.pem,client.pem,client.csr)</font></h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert <span class="attribute">-ca</span>=ca.pem <span class="attribute">-ca-key</span>=ca-key.pem <span class="attribute">-config</span>=ca-config.json <span class="attribute">-profile</span>=client client.json | cfssljson -bare client</span><br></pre></td></tr></table></figure>
<h3 id="4-1-4-创建证书存放目录-设置PEER-NAME和PRIVATE-IP环境环境变量-在三台Master上执行"><a href="#4-1-4-创建证书存放目录-设置PEER-NAME和PRIVATE-IP环境环境变量-在三台Master上执行" class="headerlink" title="4.1.4. 创建证书存放目录,设置PEER_NAME和PRIVATE_IP环境环境变量 (在三台Master上执行)"></a>4.1.4. 创建证书存放目录,设置PEER_NAME和PRIVATE_IP环境环境变量 <font color="red">(在三台Master上执行)</font></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /etc/kubernetes/pki/etcd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意下面eth0是你实际网卡的名字，有可能是eth1之类的。用ip addr查看。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> PEER_NAME=$(hostname)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> PRIVATE_IP=$(ip addr show eth0 | grep -Po <span class="string">'inet \K[\d.]+'</span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-5-在Master01上传输证书到Master02-Master03"><a href="#4-1-5-在Master01上传输证书到Master02-Master03" class="headerlink" title="4.1.5. 在Master01上传输证书到Master02,Master03"></a>4.1.5. 在Master01上传输证书到Master02,Master03</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>mv ca.pem ca-key.pem client.pem client-key.pem ca-config.json /etc/kubernetes/pki/etcd/</span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>scp /etc/kubernetes/pki/etcd/* root@&lt;master02-ipaddress&gt;<span class="symbol">:/etc/kubernetes/pki/etcd/</span></span><br><span class="line"><span class="variable">$ </span>scp /etc/kubernetes/pki/etcd/* root@&lt;master03-ipaddress&gt;<span class="symbol">:/etc/kubernetes/pki/etcd/</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-6-生成-peer-pem-peer-key-pem-server-pem-server-key-pem-在三台Master上执行"><a href="#4-1-6-生成-peer-pem-peer-key-pem-server-pem-server-key-pem-在三台Master上执行" class="headerlink" title="4.1.6 生成 peer.pem, peer-key.pem, server.pem, server-key.pem (在三台Master上执行)"></a>4.1.6 生成 peer.pem, peer-key.pem, server.pem, server-key.pem<font color="red"> (在三台Master上执行)</font></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /etc/kubernetes/pki/etcd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cfssl <span class="built_in">print</span>-defaults csr &gt; config.json</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'0,/CN/&#123;s/example\.net/'</span><span class="string">"<span class="variable">$PEER_NAME</span>"</span><span class="string">'/&#125;'</span> config.json</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'s/www\.example\.net/'</span><span class="string">"<span class="variable">$PRIVATE_IP</span>"</span><span class="string">'/'</span> config.json</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sed -i <span class="string">'s/example\.net/'</span><span class="string">"<span class="variable">$PEER_NAME</span>"</span><span class="string">'/'</span> config.json</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server config.json | cfssljson -bare server</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer config.json | cfssljson -bare peer</span></span><br></pre></td></tr></table></figure>
<h2 id="4-2-安装etcd集群-在三台Master上执行"><a href="#4-2-安装etcd集群-在三台Master上执行" class="headerlink" title="4.2. 安装etcd集群  (在三台Master上执行)"></a>4.2. 安装etcd集群 <font color="red"> (在三台Master上执行)</font></h2><h3 id="4-2-1-安装etcd"><a href="#4-2-1-安装etcd" class="headerlink" title="4.2.1 安装etcd"></a>4.2.1 安装etcd</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf /opt/kubernetes1<span class="number">.9</span><span class="number">.2</span>/bin/etcd-v3<span class="number">.2</span><span class="number">.12</span>-linux-amd64.tar.gz --strip-components=<span class="number">1</span> -C /usr/local/bin/</span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-生成etcd的环境文件"><a href="#4-2-2-生成etcd的环境文件" class="headerlink" title="4.2.2 生成etcd的环境文件"></a>4.2.2 生成etcd的环境文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> touch /etc/etcd.env</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"PEER_NAME=<span class="variable">$PEER_NAME</span>"</span> &gt;&gt; /etc/etcd.env</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"PRIVATE_IP=<span class="variable">$PRIVATE_IP</span>"</span> &gt;&gt; /etc/etcd.env</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-3-创建systemd的配置文件"><a href="#4-2-3-创建systemd的配置文件" class="headerlink" title="4.2.3 创建systemd的配置文件"></a>4.2.3 创建systemd的配置文件</h3><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ export ETCD0_IP=10.20.143.13</span><br><span class="line">$ export ETCD1_IP=10.20.143.14</span><br><span class="line">$ export ETCD2_IP=10.20.143.15</span><br><span class="line">$ export ETCD0_NAME=k8s-master01</span><br><span class="line">$ export ETCD1_NAME=k8s-master02</span><br><span class="line">$ export ETCD2_NAME=k8s-master03</span><br><span class="line">$ cat &gt;/etc/systemd/system/etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">Documentation=https://github.com/coreos/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">Conflicts=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/etcd.env</span><br><span class="line">Type=notify</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">LimitNOFILE=40000</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/local/bin/etcd --name $&#123;PEER_NAME&#125; \</span><br><span class="line">    -<span class="ruby">-data-dir /var/lib/etcd \</span></span><br><span class="line"><span class="ruby">    --listen-client-urls <span class="symbol">https:</span>/<span class="regexp">/$&#123;PRIVATE_IP&#125;:2379 \</span></span></span><br><span class="line"><span class="ruby">    --advertise-client-urls <span class="symbol">https:</span>/<span class="regexp">/$&#123;PRIVATE_IP&#125;:2379 \</span></span></span><br><span class="line"><span class="ruby">    --listen-peer-urls <span class="symbol">https:</span>/<span class="regexp">/$&#123;PRIVATE_IP&#125;:2380 \</span></span></span><br><span class="line"><span class="ruby">    --initial-advertise-peer-urls <span class="symbol">https:</span>/<span class="regexp">/$&#123;PRIVATE_IP&#125;:2380 \</span></span></span><br><span class="line"><span class="ruby">    --cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/pki/etcd</span><span class="regexp">/server.pem \</span></span></span><br><span class="line"><span class="ruby">    --key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/pki/etcd</span><span class="regexp">/server-key.pem \</span></span></span><br><span class="line"><span class="ruby">    --client-cert-auth \</span></span><br><span class="line"><span class="ruby">    --trusted-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/pki/etcd</span><span class="regexp">/ca.pem \</span></span></span><br><span class="line"><span class="ruby">    --peer-cert-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/pki/etcd</span><span class="regexp">/peer.pem \</span></span></span><br><span class="line"><span class="ruby">    --peer-key-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/pki/etcd</span><span class="regexp">/peer-key.pem \</span></span></span><br><span class="line"><span class="ruby">    --peer-client-cert-auth \</span></span><br><span class="line"><span class="ruby">    --peer-trusted-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/pki/etcd</span><span class="regexp">/ca.pem \</span></span></span><br><span class="line"><span class="ruby">    --initial-cluster $&#123;ETCD0_NAME&#125;=<span class="symbol">https:</span>/<span class="regexp">/$&#123;ETCD0_IP&#125;:2380,$&#123;ETCD1_NAME&#125;=https:/</span><span class="regexp">/$&#123;ETCD1_IP&#125;:2380,$&#123;ETCD2_NAME&#125;=https:/</span><span class="regexp">/$&#123;ETCD2_IP&#125;:2380 \</span></span></span><br><span class="line"><span class="ruby">    --initial-cluster-token my-etcd-token \</span></span><br><span class="line"><span class="ruby">    --initial-cluster-state new</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">[Install]</span></span><br><span class="line"><span class="ruby">WantedBy=multi-user.target</span></span><br><span class="line"><span class="ruby">EOF</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-4-启动etcd集群"><a href="#4-2-4-启动etcd集群" class="headerlink" title="4.2.4. 启动etcd集群"></a>4.2.4. 启动etcd集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl daemon-reload</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl start etcd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">enable</span> etcd</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-5-验证集群状态"><a href="#4-2-5-验证集群状态" class="headerlink" title="4.2.5. 验证集群状态"></a>4.2.5. 验证集群状态</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl <span class="attribute">--cert-file</span>=/etc/kubernetes/pki/etcd/server.pem <span class="attribute">--ca-file</span>=/etc/kubernetes/pki/etcd/ca.pem  <span class="attribute">--key-file</span>=/etc/kubernetes/pki/etcd/server-key.pem <span class="attribute">--endpoints</span>=https://10.20.143.13:2379,https://10.20.143.14:2379,https://10.20.143.15:2379 member list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出以下类似结果,集群安装成功</span></span><br><span class="line">6833d3ff7f25e53c: <span class="attribute">name</span>=k8s.test.master03 <span class="attribute">peerURLs</span>=https://10.20.143.15:2380 <span class="attribute">clientURLs</span>=https://10.20.143.15:2379 <span class="attribute">isLeader</span>=<span class="literal">false</span></span><br><span class="line">d715f6e539919304: <span class="attribute">name</span>=k8s.test.master02 <span class="attribute">peerURLs</span>=https://10.20.143.14:2380 <span class="attribute">clientURLs</span>=https://10.20.143.14:2379 <span class="attribute">isLeader</span>=<span class="literal">false</span></span><br><span class="line">e2c6d0f2545d5d78: <span class="attribute">name</span>=k8s.test.master01 <span class="attribute">peerURLs</span>=https://10.20.143.13:2380 <span class="attribute">clientURLs</span>=https://10.20.143.13:2379 <span class="attribute">isLeader</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="4-3-创建kubernetes集群"><a href="#4-3-创建kubernetes集群" class="headerlink" title="4.3. 创建kubernetes集群"></a>4.3. 创建kubernetes集群</h2><h3 id="4-3-1-kubeadm配置"><a href="#4-3-1-kubeadm配置" class="headerlink" title="4.3.1. kubeadm配置"></a>4.3.1. kubeadm配置</h3><blockquote>
<p>修改配置 /opt/kubernetes1.9.2/configuration/kube/config 文件</p>
</blockquote>
<blockquote>
<p>apiServerCertSANs #此处填所有的masterip和lbip和其它你可能需要通过它访问apiserver的地址和域名或者主机名等</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm<span class="selector-class">.k8s</span><span class="selector-class">.io</span>/v1alpha1</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- <span class="number">10.20</span>.<span class="number">143.12</span></span><br><span class="line">- <span class="number">10.20</span>.<span class="number">143.13</span></span><br><span class="line">- <span class="number">10.20</span>.<span class="number">143.14</span></span><br><span class="line">- <span class="number">10.20</span>.<span class="number">143.15</span></span><br><span class="line">- k8s<span class="selector-class">.test</span><span class="selector-class">.master01</span></span><br><span class="line">- k8s<span class="selector-class">.test</span><span class="selector-class">.master02</span></span><br><span class="line">- k8s<span class="selector-class">.test</span><span class="selector-class">.master03</span></span><br><span class="line">- k8s<span class="selector-class">.test</span><span class="selector-class">.node01</span></span><br><span class="line">- k8s<span class="selector-class">.test</span><span class="selector-class">.node02</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">etcd:</span><br><span class="line">  endpoints:</span><br><span class="line">  - https:<span class="comment">//10.20.143.13:2379</span></span><br><span class="line">  - https:<span class="comment">//10.20.143.14:2379</span></span><br><span class="line">  - https:<span class="comment">//10.20.143.15:2379</span></span><br><span class="line">  caFile: /etc/kubernetes/pki/etcd/ca.pem</span><br><span class="line">  certFile: /etc/kubernetes/pki/etcd/client.pem</span><br><span class="line">  keyFile: /etc/kubernetes/pki/etcd/client-key.pem</span><br><span class="line"></span><br><span class="line">apiServerExtraArgs:</span><br><span class="line">  apiserver-count: <span class="number">3</span></span><br><span class="line"></span><br><span class="line">networking:</span><br><span class="line">  podSubnet: <span class="number">192.168</span>.<span class="number">0.0</span>/<span class="number">16</span></span><br><span class="line">kubernetesVersion: v1.<span class="number">9.2</span></span><br><span class="line">featureGates:</span><br><span class="line">   CoreDNS: true</span><br></pre></td></tr></table></figure>
<h3 id="4-3-2-运行kubeadm"><a href="#4-3-2-运行kubeadm" class="headerlink" title="4.3.2 运行kubeadm"></a>4.3.2 运行kubeadm</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>kubeadm init --config=<span class="regexp">/opt/kubernetes</span>1.<span class="number">9.2</span>/configuration/kube/config</span><br><span class="line"><span class="variable">$ </span>mkdir ~<span class="regexp">/.kube &amp;&amp; cp /etc</span><span class="regexp">/kubernetes/admin</span>.conf ~<span class="regexp">/.kube/config</span></span><br></pre></td></tr></table></figure>
<blockquote>
<font color="red">牢记生成的 kubeadm join 命令  </font>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> <span class="selector-tag">--token</span> <span class="selector-tag">c97226</span><span class="selector-class">.dc9b3c8ab883b5cb</span> 10<span class="selector-class">.20</span><span class="selector-class">.143</span><span class="selector-class">.13</span><span class="selector-pseudo">:6443</span> <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:70e980b465032f712c06fe9ccecb116c7b2dbd4f682edf88e6627324b583a9d0</span></span><br></pre></td></tr></table></figure>
<h3 id="4-3-3-启动多个Master"><a href="#4-3-3-启动多个Master" class="headerlink" title="4.3.3 启动多个Master"></a>4.3.3 启动多个Master</h3><blockquote>
<font color="red">在master1上拷贝相关配置文件到master02,master03上</font>
</blockquote>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>scp /etc/kubernetes/pki/* root<span class="variable">@10</span>.<span class="number">20.143</span>.<span class="number">14</span><span class="symbol">:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="variable">$ </span>scp /etc/kubernetes/pki/* root<span class="variable">@10</span>.<span class="number">20.143</span>.<span class="number">15</span><span class="symbol">:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="variable">$ </span>scp /opt/kubernetes1.<span class="number">9.2</span>/configuration/kube/config root<span class="variable">@10</span>.<span class="number">20.143</span>.<span class="number">14</span><span class="symbol">:/root/</span></span><br><span class="line"><span class="variable">$ </span>scp /opt/kubernetes1.<span class="number">9.2</span>/configuration/kube/config root<span class="variable">@10</span>.<span class="number">20.143</span>.<span class="number">15</span><span class="symbol">:/root/</span></span><br></pre></td></tr></table></figure>
<blockquote>
<font color="red">登陆master02,master03执行以下相同命令</font>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除pki目录下的apiserver.crt 和 apiserver.key文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span>  /etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rm -rf apiserver.crt apiserver.key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建master02,master03</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm init --config ~/config</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>验证master集群</p>
</blockquote>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl  get nodes</span><br><span class="line">NAME                STATUS    ROLES     AGE       <span class="keyword">VERSION</span></span><br><span class="line">k8s.test.master01   Ready     <span class="keyword">master</span>    <span class="title">2d</span>        v1.<span class="number">9.2</span></span><br><span class="line">k8s.test.master02   Ready     <span class="keyword">master</span>    <span class="title">2d</span>        v1.<span class="number">9.2</span></span><br><span class="line">k8s.test.master03   Ready     <span class="keyword">master</span>    <span class="title">2d</span>        v1.<span class="number">9.2</span></span><br></pre></td></tr></table></figure>
<h3 id="4-3-4-启动loadbalance-在loadbalance节点上执行"><a href="#4-3-4-启动loadbalance-在loadbalance节点上执行" class="headerlink" title="4.3.4 启动loadbalance (在loadbalance节点上执行)"></a>4.3.4 启动loadbalance (在loadbalance节点上执行)</h3><h4 id="4-3-4-1-修改配置文件"><a href="#4-3-4-1-修改配置文件" class="headerlink" title="4.3.4.1 修改配置文件"></a>4.3.4.1 修改配置文件</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ cat /opt/kubernetes1.9.2/configuration/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">  daemon</span><br><span class="line">  log 127.0.0.1 local0</span><br><span class="line">  log 127.0.0.1 local1 notice</span><br><span class="line">  maxconn 4096</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  log               global</span><br><span class="line">  retries           3</span><br><span class="line">  maxconn           2000</span><br><span class="line">  timeout connect   5s</span><br><span class="line">  timeout<span class="built_in"> client </span>   50s</span><br><span class="line">  timeout<span class="built_in"> server </span>   50s</span><br><span class="line"></span><br><span class="line">frontend k8s</span><br><span class="line">  bind *:6444 #安装包中的配置文件多了一个 冒号: 注意修改!!!</span><br><span class="line">  mode tcp</span><br><span class="line">  default_backend k8s-backend</span><br><span class="line"></span><br><span class="line">backend k8s-backend</span><br><span class="line">  balance roundrobin</span><br><span class="line">  mode tcp</span><br><span class="line">  #下面三个ip替换成三个你自己master的地址</span><br><span class="line"> <span class="built_in"> server </span>k8s-0 10.20.143.13:6443 check</span><br><span class="line"> <span class="built_in"> server </span>k8s-1 10.20.143.14:6443 check</span><br><span class="line"> <span class="built_in"> server </span>k8s-2 10.20.143.15:6443 check</span><br></pre></td></tr></table></figure>
<h4 id="4-3-4-2-启动haproxy"><a href="#4-3-4-2-启动haproxy" class="headerlink" title="4.3.4.2 启动haproxy"></a>4.3.4.2 启动haproxy</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir <span class="regexp">/etc/</span>haproxy</span><br><span class="line">$ cp <span class="regexp">/opt/</span>kubernetes1<span class="number">.9</span><span class="number">.2</span><span class="regexp">/configuration/</span>haproxy<span class="regexp">/haproxy.cfg /</span>etc<span class="regexp">/haproxy/</span>haproxy.cfg</span><br><span class="line">$ docker run --restart always --net=host -v <span class="regexp">/etc/</span><span class="string">haproxy:</span><span class="regexp">/usr/</span>local<span class="regexp">/etc/</span>haproxy --name k8s-haproxy -d <span class="string">haproxy:</span><span class="number">1.7</span></span><br></pre></td></tr></table></figure>
<h4 id="4-3-4-3-修改kubeproxy配置-在master01上"><a href="#4-3-4-3-修改kubeproxy配置-在master01上" class="headerlink" title="4.3.4.3 修改kubeproxy配置(在master01上)"></a>4.3.4.3 修改kubeproxy配置<font color="red">(在master01上)</font></h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n kube-system edit configmap kube-proxy <span class="meta">#找到文件的这一块，第七行server 有个ip地址</span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">    kind:</span> Config</span><br><span class="line"><span class="symbol">    clusters:</span></span><br><span class="line">    - cluster:</span><br><span class="line">        certificate-authority: <span class="meta-keyword">/var/</span>run<span class="meta-keyword">/secrets/</span>kubernetes.io<span class="meta-keyword">/serviceaccount/</span>ca.crt</span><br><span class="line"><span class="symbol">        server:</span> https:<span class="comment">//10.230.204.151:6443 #修改为 LoadBalanceIP:6444</span></span><br><span class="line"><span class="symbol">      name:</span> default</span><br><span class="line"><span class="symbol">    contexts:</span></span><br><span class="line">    - context:</span><br><span class="line"><span class="symbol">        cluster:</span> default</span><br><span class="line"><span class="symbol">        namespace:</span> default</span><br><span class="line"><span class="symbol">        user:</span> default</span><br><span class="line"><span class="symbol">      name:</span> default</span><br><span class="line">    current-context: default</span><br><span class="line"><span class="symbol">    users:</span></span><br><span class="line">    - name: default</span><br><span class="line"><span class="symbol">      user:</span></span><br><span class="line"><span class="symbol">        tokenFile:</span> <span class="meta-keyword">/var/</span>run<span class="meta-keyword">/secrets/</span>kubernetes.io<span class="meta-keyword">/serviceaccount/</span>token</span><br></pre></td></tr></table></figure>
<h3 id="4-3-5-Join-Node-节点"><a href="#4-3-5-Join-Node-节点" class="headerlink" title="4.3.5 Join Node 节点"></a>4.3.5 Join Node 节点</h3><blockquote>
<p>kubeadm join</p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm <span class="keyword">join</span> --token <span class="symbol">&lt;token&gt;</span> <span class="number">10.20</span>.<span class="number">143.13</span>:<span class="number">6443</span> --discovery-token-<span class="keyword">ca</span>-cert-hash <span class="built_in">sha256</span>:<span class="symbol">&lt;hash&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<font color="red">修改node节点kubelet配置</font>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">/etc/kubernetes/kubelet.conf</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="attr">- cluster:</span></span><br><span class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">xxxxxx</span> <span class="comment">#此处省略几百字符</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr">https://10.20.143.12:6444</span> <span class="comment">#修改这里为LB:6444，</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-cluster</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="attr">- context:</span></span><br><span class="line"><span class="attr">    cluster:</span> <span class="string">default-cluster</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">default-auth</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-context</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">default-context</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">kubelet</span></span><br></pre></td></tr></table></figure>
<h3 id="4-3-6-创建Calico-CNI网络-在master01上"><a href="#4-3-6-创建Calico-CNI网络-在master01上" class="headerlink" title="4.3.6 创建Calico CNI网络 (在master01上)"></a>4.3.6 创建Calico CNI网络 <font color="red">(在master01上)</font></h3><blockquote>
<p>配置calico网络需要的TLS calico-etcd-secrets</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd  /opt/kubernetes1.<span class="number">9.2</span>/configuration/net</span><br><span class="line">$ sed -<span class="selector-tag">i</span> <span class="string">"s/\$ETCDCA/`cat /etc/kubernetes/pki/etcd/ca.pem | base64 | tr -d '\n'`/"</span> calico-tls.yaml</span><br><span class="line">$ sed -<span class="selector-tag">i</span> <span class="string">"s/\$ETCDCERT/`cat /etc/kubernetes/pki/etcd/server.pem | base64 | tr -d '\n'`/"</span> calico-tls.yaml</span><br><span class="line">$ sed -<span class="selector-tag">i</span> <span class="string">"s/\$ETCDKYE/`cat /etc/kubernetes/pki/etcd/server-key.pem | base64 | tr -d '\n'`/"</span> calico-tls.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>修改calico-tls.yaml中 etcd_endpoints 为上面装的etcd集群地址</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Calico Version v3.0.4</span></span><br><span class="line"><span class="comment"># https://docs.projectcalico.org/v3.0/releases#v3.0.4</span></span><br><span class="line"><span class="comment"># This manifest includes the following component versions:</span></span><br><span class="line"><span class="comment">#   calico/node:v3.0.4</span></span><br><span class="line"><span class="comment">#   calico/cni:v2.0.3</span></span><br><span class="line"><span class="comment">#   calico/kube-controllers:v2.0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This ConfigMap is used to configure a self-hosted Calico installation.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">calico-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># Configure this with the location of your etcd cluster.</span></span><br><span class="line"><span class="attr">  etcd_endpoints:</span> <span class="string">"https://127.0.0.1:2379"</span> <span class="comment">#改成正确的etcd集群地址"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Configure the Calico backend to use.</span></span><br><span class="line"><span class="attr">  calico_backend:</span> <span class="string">"bird"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The CNI network configuration to install on each node.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>安装网络</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f rbac.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f calico-tls.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="4-3-7-安装监控和WEB-UI-在master01上"><a href="#4-3-7-安装监控和WEB-UI-在master01上" class="headerlink" title="4.3.7 安装监控和WEB UI (在master01上)"></a>4.3.7 安装监控和WEB UI (在master01上)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/kubernetes1.9.2/configuration</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f heapster/influxdb</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f heapster/rbac</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f dashboard</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Web UI 访问地址: https://<node-ip>:32000</node-ip></p>
</blockquote>
<h1 id="5-部署Ingress"><a href="#5-部署Ingress" class="headerlink" title="5.部署Ingress"></a>5.部署Ingress</h1><h2 id="5-1-架构图"><a href="#5-1-架构图" class="headerlink" title="5.1. 架构图"></a>5.1. 架构图</h2><p><img src="http://7xlovv.com1.z0.glb.clouddn.com/ingress-controller.png" alt="image"></p>
<h2 id="5-2-创建-ingress-nginx"><a href="#5-2-创建-ingress-nginx" class="headerlink" title="5.2. 创建 ingress-nginx"></a>5.2. 创建 ingress-nginx</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/kubernetes1.9.2/configuration/ingress</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f namespace.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f default-backend.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f configmap.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f tcp-services-configmap.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f udp-services-configmap.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f rbac.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f with-rbac.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/kubernetes1.9.2/configuration/ingress/provider/baremetal</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f service-nodeport.yaml</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl  get svc -n ingress-nginx</span></span><br><span class="line">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">default-http-backend   ClusterIP   10.109.228.128   &lt;none&gt;        80/TCP                       2h</span><br><span class="line">ingress-nginx          NodePort    10.97.114.177    &lt;none&gt;        80:32358/TCP,443:31164/TCP   2h</span><br></pre></td></tr></table></figure>
<h2 id="5-3-测试验证"><a href="#5-3-测试验证" class="headerlink" title="5.3. 测试验证"></a>5.3. 测试验证</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">run</span> <span class="bullet">--image=nginx</span> <span class="string">nginx-web01</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">expose</span> <span class="string">deployment</span> <span class="string">nginx-web01</span> <span class="bullet">--port=80</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">run</span> <span class="bullet">--image=nginx</span> <span class="string">nginx-web02</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">expose</span> <span class="string">deployment</span> <span class="string">nginx-web02</span> <span class="bullet">--port=80</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">&gt; nginx-web-test.yaml</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ingress-http-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">web01.test.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">        - backend:</span></span><br><span class="line"><span class="attr">            serviceName:</span> <span class="string">nginx-web01</span></span><br><span class="line"><span class="attr">            servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">web02.test.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">        - backend:</span></span><br><span class="line"><span class="attr">            serviceName:</span> <span class="string">nginx-web02</span></span><br><span class="line"><span class="attr">            servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span>  <span class="string">nginx-web-test.yaml</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>LB配置,将域名解析至lb或者绑定hosts,后访问域名即可.</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend http-test</span><br><span class="line">  bind *:80</span><br><span class="line">  mode tcp</span><br><span class="line">  default_backend http-test</span><br><span class="line"></span><br><span class="line">backend http-test</span><br><span class="line">  balance roundrobin</span><br><span class="line">  mode tcp</span><br><span class="line"> <span class="built_in"> server </span>k8s-0 10.20.143.13:32358 check</span><br><span class="line"> <span class="built_in"> server </span>k8s-1 10.20.143.14:32358 check</span><br><span class="line"> <span class="built_in"> server </span>k8s-2 10.20.143.15:32358 check</span><br></pre></td></tr></table></figure>
<h1 id="6-Done"><a href="#6-Done" class="headerlink" title="6.Done."></a>6.Done.</h1></div><div class="tags"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://h22f.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/18/部署高可用kubernetes集群v1-9-2/">部署高可用kubernetes集群v1.9.2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://hujianxiong.com" title="胡剑雄 博客" target="_blank">胡剑雄 博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">H22F's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>